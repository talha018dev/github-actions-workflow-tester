name: PR Analysis & Review (with Cursor)

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  # SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
  # SONAR_ORGANIZATION: ${{ secrets.SONAR_ORGANIZATION }}
  CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

jobs:
  # codeql-analysis:
  #   name: CodeQL Security Analysis
  #   runs-on: ubuntu-latest
  #   permissions:
  #     actions: read
  #     contents: read
  #     security-events: write
  #
  #   strategy:
  #     fail-fast: false
  #     matrix:
  #       language: ['javascript', 'typescript']
  #
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4
  #
  #     - name: Initialize CodeQL
  #       uses: github/codeql-action/init@v3
  #       with:
  #         languages: ${{ matrix.language }}
  #         queries: security-extended,security-and-quality
  #
  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: ${{ env.NODE_VERSION }}
  #         cache: 'npm'
  #
  #     - name: Install dependencies
  #       run: npm ci
  #
  #     - name: Perform CodeQL Analysis
  #       uses: github/codeql-action/analyze@v3
  #       with:
  #         category: "/language:${{matrix.language}}"

  # sonarcloud-analysis:
  #   name: SonarCloud Code Quality
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0

  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: ${{ env.NODE_VERSION }}
  #         cache: 'npm'

  #     - name: Install dependencies
  #       run: npm ci

  #     - name: Run tests (if available)
  #       run: npm test --if-present
  #       continue-on-error: true

  #     - name: SonarCloud Scan
  #       uses: SonarSource/sonarcloud-github-action@master
  #       env:
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #         SONAR_TOKEN: ${{ env.SONAR_TOKEN }}
  #         SONAR_ORGANIZATION: ${{ env.SONAR_ORGANIZATION }}

  cursor-ai-review:
    name: Cursor AI-Powered PR Review
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci
        continue-on-error: true

      - name: Get PR changes
        id: pr-changes
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            
            const codeFiles = files
              .filter(f => f.status !== 'removed' && 
                      (f.filename.endsWith('.ts') || f.filename.endsWith('.tsx') || 
                       f.filename.endsWith('.js') || f.filename.endsWith('.jsx') ||
                       f.filename.endsWith('.css')))
              .map(f => {
                const patch = f.patch || '';
                const truncatedPatch = patch.length > 5000 ? patch.substring(0, 5000) : patch;
                return {
                  filename: f.filename,
                  status: f.status,
                  additions: f.additions,
                  deletions: f.deletions,
                  patch: truncatedPatch
                };
              });
            
            const prData = {
              title: pr.title || '',
              body: pr.body || '',
              files: codeFiles,
              base: pr.base.sha,
              head: pr.head.sha
            };
            
            core.setOutput('result', JSON.stringify(prData));

      - name: Run Cursor AI Review
        id: cursor-review
        uses: actions/github-script@v7
        env:
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PR_DATA: ${{ steps.pr-changes.outputs.result }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const https = require('https');
            const prDataStr = process.env.PR_DATA || '';
            
            if (!prDataStr || prDataStr === '') {
              core.setOutput('review', 'âš ï¸ Failed to get PR data.');
              return;
            }
            
            let prData;
            try {
              // Remove any potential BOM or whitespace
              const cleaned = prDataStr.trim();
              if (!cleaned || cleaned === '') {
                core.setOutput('review', 'âš ï¸ PR data is empty');
                return;
              }
              prData = JSON.parse(cleaned);
            } catch (e) {
              core.setOutput('review', 'âš ï¸ Failed to parse PR data: ' + e.message + '. Data length: ' + prDataStr.length);
              console.error('PR Data (first 200 chars):', prDataStr.substring(0, 200));
              return;
            }
            
            // Use OPENAI_API_KEY if CURSOR_API_KEY is not available (Cursor uses OpenAI API)
            const apiKey = process.env.CURSOR_API_KEY || process.env.OPENAI_API_KEY;
            
            if (!apiKey) {
              core.setOutput('review', 'âš ï¸ Neither CURSOR_API_KEY nor OPENAI_API_KEY secret is configured. Please add one of these secrets in repository settings.');
              return;
            }
            
            if (!prData.files || prData.files.length === 0) {
              core.setOutput('review', 'âœ… No code files changed in this PR.');
              return;
            }
            
            const systemPrompt = 'You are an expert code reviewer specializing in Next.js, React, TypeScript, and modern web development. Provide a concise, actionable code review focusing on: 1. Critical Issues: Security vulnerabilities, bugs, or breaking changes 2. Code Quality: Best practices, patterns, and maintainability 3. Suggestions: Specific improvements with code examples when helpful 4. Positive Feedback: Acknowledge good practices and clean code. Format your response in markdown with clear sections. Be constructive and specific.';
            
            const fileSummaries = prData.files.map(f => {
              const patch = f.patch || 'No diff available';
              const truncatedPatch = patch.length > 3000 ? patch.substring(0, 3000) + '...' : patch;
              return '### ' + f.filename + ' (' + f.status + ')\n- Additions: +' + f.additions + ', Deletions: -' + f.deletions + '\n```diff\n' + truncatedPatch + '\n```';
            }).join('\n\n');
            
            const userPrompt = 'Review this pull request:\n\n**PR Title**: ' + (prData.title || 'N/A') + '\n**PR Description**: ' + (prData.body || 'No description provided') + '\n\n**Changed Files**:\n' + fileSummaries + '\n\nPlease provide a comprehensive code review.';
            
            const data = JSON.stringify({
              model: 'gpt-4-turbo-preview',
              messages: [
                { role: 'system', content: systemPrompt },
                { role: 'user', content: userPrompt }
              ],
              temperature: 0.3,
              max_tokens: 2000,
            });
            
            return new Promise((resolve) => {
              const options = {
                hostname: 'api.openai.com',
                port: 443,
                path: '/v1/chat/completions',
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': 'Bearer ' + apiKey,
                  'Content-Length': data.length,
                },
              };
              
              const req = https.request(options, (res) => {
                let responseData = '';
                res.on('data', (chunk) => { responseData += chunk; });
                res.on('end', () => {
                  try {
                    if (res.statusCode === 200) {
                      const response = JSON.parse(responseData);
                      const review = response.choices[0].message.content;
                      core.setOutput('review', review);
                    } else {
                      const errorMsg = responseData.length > 500 ? responseData.substring(0, 500) : responseData;
                      core.setOutput('review', 'âš ï¸ Error generating AI review (' + res.statusCode + '): ' + errorMsg);
                    }
                  } catch (e) {
                    core.setOutput('review', 'âš ï¸ Error parsing response: ' + e.message);
                  }
                  resolve();
                });
              });
              
              req.on('error', (error) => {
                core.setOutput('review', 'âš ï¸ Error calling API: ' + error.message);
                resolve();
              });
              
              req.setTimeout(30000, () => {
                req.destroy();
                core.setOutput('review', 'âš ï¸ Request timeout after 30 seconds');
                resolve();
              });
              
              req.write(data);
              req.end();
            });

      - name: Post Cursor Review Comment
        uses: actions/github-script@v7
        if: steps.cursor-review.outputs.review
        env:
          REVIEW_TEXT: ${{ steps.cursor-review.outputs.review }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const review = process.env.REVIEW_TEXT || '';
            
            if (!review || review.includes('âš ï¸')) {
              console.log('Skipping comment due to review error or warning');
              return;
            }
            
            try {
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });
              
              const existingComment = comments.find(c => 
                c.user && c.user.type === 'Bot' && 
                c.body && c.body.includes('ðŸ¤– Cursor AI Code Review')
              );
              
              const commentBody = '## ðŸ¤– Cursor AI Code Review\n\n' + review + '\n\n---\n*This review was automatically generated using Cursor AI via GitHub Actions.*';
              
              if (existingComment) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: existingComment.id,
                  body: commentBody
                });
                console.log('Updated existing review comment');
              } else {
                await github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: commentBody
                });
                console.log('Created new review comment');
              }
            } catch (error) {
              console.error('Error posting comment:', error.message);
              if (error.status === 403) {
                console.error('Permission denied. This might be a PR from a fork. Forks have limited permissions.');
                console.error('Review content:', review.substring(0, 200) + '...');
              }
              throw error;
            }

  summary:
    name: Analysis Summary
    runs-on: ubuntu-latest
    needs: [cursor-ai-review]
    if: always()
    permissions:
      contents: read
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create Summary Comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const cursorReviewStatus = '${{ needs.cursor-ai-review.result }}';
            
            const statusIcon = (status) => {
              if (status === 'success') return 'âœ…';
              if (status === 'failure') return 'âŒ';
              if (status === 'cancelled') return 'âš ï¸';
              return 'â¸ï¸';
            };
            
            const summary = '## ðŸ“Š PR Analysis Summary\n\n| Analysis | Status |\n|----------|--------|\n| Cursor AI Review | ' + statusIcon(cursorReviewStatus) + ' ' + cursorReviewStatus + ' |\n\n### ðŸ” Details\n- **Cursor AI**: Automated code review using Cursor AI completed\n\n' + (cursorReviewStatus === 'failure' ? 'âš ï¸ **Action Required**: Please review the failed checks above.' : 'âœ… Review completed!') + '\n\n---\n*This summary is automatically generated by GitHub Actions.*';
            
            try {
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });
              
              const existingSummary = comments.find(c => 
                c.user && c.user.type === 'Bot' && 
                c.body && c.body.includes('ðŸ“Š PR Analysis Summary')
              );
              
              if (existingSummary) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: existingSummary.id,
                  body: summary
                });
                console.log('Updated existing summary comment');
              } else {
                await github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: summary
                });
                console.log('Created new summary comment');
              }
            } catch (error) {
              console.error('Error posting summary comment:', error.message);
              if (error.status === 403) {
                console.error('Permission denied. This might be a PR from a fork. Forks have limited permissions.');
              }
              // Don't throw - allow workflow to complete even if comment fails
            }

