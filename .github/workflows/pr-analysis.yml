name: PR Analysis & Review

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
  SONAR_ORGANIZATION: ${{ secrets.SONAR_ORGANIZATION }}

jobs:
  codeql-analysis:
    name: CodeQL Security Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: ['javascript', 'typescript']

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          queries: security-extended,security-and-quality

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{matrix.language}}"

  sonarcloud-analysis:
    name: SonarCloud Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for better analysis

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests (if available)
        run: npm test --if-present
        continue-on-error: true

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ env.SONAR_TOKEN }}
          SONAR_ORGANIZATION: ${{ env.SONAR_ORGANIZATION }}

  ai-pr-review:
    name: AI-Powered PR Review
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci

      - name: Get PR changes
        id: pr-changes
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            
            const codeFiles = files
              .filter(f => f.status !== 'removed' && 
                      (f.filename.endsWith('.ts') || f.filename.endsWith('.tsx') || 
                       f.filename.endsWith('.js') || f.filename.endsWith('.jsx')))
              .map(f => ({
                filename: f.filename,
                status: f.status,
                additions: f.additions,
                deletions: f.deletions,
                patch: f.patch ? f.patch.substring(0, 3000) : ''
              }));
            
            return JSON.stringify({
              title: pr.title,
              body: pr.body || '',
              files: codeFiles
            });

      - name: Run AI PR Review
        id: ai-review
        uses: actions/github-script@v7
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const https = require('https');
            const prData = JSON.parse('${{ steps.pr-changes.outputs.result }}');
            
            if (!process.env.OPENAI_API_KEY) {
              core.setOutput('review', 'âš ï¸ OPENAI_API_KEY secret is not configured. Skipping AI review.');
              return;
            }
            
            if (prData.files.length === 0) {
              core.setOutput('review', 'âœ… No code files changed in this PR.');
              return;
            }
            
            const systemPrompt = `You are an expert code reviewer specializing in Next.js, React, TypeScript, and modern web development. Provide a concise, actionable code review focusing on:
1. **Critical Issues**: Security vulnerabilities, bugs, or breaking changes
2. **Code Quality**: Best practices, patterns, and maintainability  
3. **Suggestions**: Specific improvements with code examples when helpful
4. **Positive Feedback**: Acknowledge good practices and clean code

Format your response in markdown with clear sections. Be constructive and specific.`;
            
            const fileSummaries = prData.files.map(f => 
              `### ${f.filename} (${f.status})\n- Additions: +${f.additions}, Deletions: -${f.deletions}\n\`\`\`diff\n${f.patch || 'No diff available'}\n\`\`\``
            ).join('\n\n');
            
            const userPrompt = `Review this pull request:

**PR Title**: ${prData.title || 'N/A'}
**PR Description**: ${prData.body || 'No description provided'}

**Changed Files**:
${fileSummaries}

Please provide a comprehensive code review.`;
            
            const data = JSON.stringify({
              model: 'gpt-4-turbo-preview',
              messages: [
                { role: 'system', content: systemPrompt },
                { role: 'user', content: userPrompt }
              ],
              temperature: 0.3,
              max_tokens: 2000,
            });
            
            return new Promise((resolve, reject) => {
              const options = {
                hostname: 'api.openai.com',
                port: 443,
                path: '/v1/chat/completions',
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${process.env.OPENAI_API_KEY}`,
                  'Content-Length': data.length,
                },
              };
              
              const req = https.request(options, (res) => {
                let responseData = '';
                res.on('data', (chunk) => { responseData += chunk; });
                res.on('end', () => {
                  if (res.statusCode === 200) {
                    const response = JSON.parse(responseData);
                    const review = response.choices[0].message.content;
                    core.setOutput('review', review);
                    resolve();
                  } else {
                    core.setOutput('review', `âš ï¸ Error generating AI review: ${res.statusCode} - ${responseData}`);
                    resolve();
                  }
                });
              });
              
              req.on('error', (error) => {
                core.setOutput('review', `âš ï¸ Error calling OpenAI API: ${error.message}`);
                resolve();
              });
              
              req.write(data);
              req.end();
            });

      - name: Post AI Review Comment
        uses: actions/github-script@v7
        if: steps.ai-review.outputs.review
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const review = `${{ steps.ai-review.outputs.review }}`;
            
            // Check if we already posted a review comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const existingComment = comments.find(c => 
              c.user.type === 'Bot' && 
              c.body.includes('ðŸ¤– AI-Powered Code Review')
            );
            
            const commentBody = `## ðŸ¤– AI-Powered Code Review\n\n${review}\n\n---\n*This review was automatically generated by GitHub Actions.*`;
            
            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: commentBody
              });
            }

  summary:
    name: Analysis Summary
    runs-on: ubuntu-latest
    needs: [codeql-analysis, sonarcloud-analysis, ai-pr-review]
    if: always()
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create Summary Comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const codeqlStatus = '${{ needs.codeql-analysis.result }}';
            const sonarStatus = '${{ needs.sonarcloud-analysis.result }}';
            const aiReviewStatus = '${{ needs.ai-pr-review.result }}';
            
            const statusIcon = (status) => {
              if (status === 'success') return 'âœ…';
              if (status === 'failure') return 'âŒ';
              if (status === 'cancelled') return 'âš ï¸';
              return 'â¸ï¸';
            };
            
            const summary = `## ðŸ“Š PR Analysis Summary
            
            | Analysis | Status |
            |----------|--------|
            | CodeQL Security | ${statusIcon(codeqlStatus)} ${codeqlStatus} |
            | SonarCloud Quality | ${statusIcon(sonarStatus)} ${sonarStatus} |
            | AI Code Review | ${statusIcon(aiReviewStatus)} ${aiReviewStatus} |
            
            ### ðŸ” Details
            - **CodeQL**: Security vulnerability scanning completed
            - **SonarCloud**: Code quality and maintainability analysis completed
            - **AI Review**: Automated code review with suggestions completed
            
            ${codeqlStatus === 'failure' || sonarStatus === 'failure' ? 'âš ï¸ **Action Required**: Please review the failed checks above.' : 'âœ… All checks passed!'}
            
            ---
            *This summary is automatically generated by GitHub Actions.*
            `;
            
            // Check if summary comment already exists
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const existingSummary = comments.find(c => 
              c.user.type === 'Bot' && 
              c.body.includes('ðŸ“Š PR Analysis Summary')
            );
            
            if (existingSummary) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingSummary.id,
                body: summary
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: summary
              });
            }
