name: PR Analysis & Review (with Cursor)

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  # SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
  # SONAR_ORGANIZATION: ${{ secrets.SONAR_ORGANIZATION }}
  CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}

jobs:
  codeql-analysis:
    name: CodeQL Security Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: ['javascript', 'typescript']

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          queries: security-extended,security-and-quality

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{matrix.language}}"

  # sonarcloud-analysis:
  #   name: SonarCloud Code Quality
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0

  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: ${{ env.NODE_VERSION }}
  #         cache: 'npm'

  #     - name: Install dependencies
  #       run: npm ci

  #     - name: Run tests (if available)
  #       run: npm test --if-present
  #       continue-on-error: true

  #     - name: SonarCloud Scan
  #       uses: SonarSource/sonarcloud-github-action@master
  #       env:
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #         SONAR_TOKEN: ${{ env.SONAR_TOKEN }}
  #         SONAR_ORGANIZATION: ${{ env.SONAR_ORGANIZATION }}

  cursor-ai-review:
    name: Cursor AI-Powered PR Review
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Cursor CLI
        run: |
          # Install Cursor CLI
          # Check if Cursor CLI is available via npm or direct download
          if command -v cursor &> /dev/null; then
            echo "Cursor CLI already installed"
          else
            # Try installing via npm if available as a package
            npm install -g @cursor/cli 2>/dev/null || \
            # Or download from Cursor's releases
            curl -L https://cursor.sh/cli/install.sh | sh || \
            echo "‚ö†Ô∏è Cursor CLI installation failed. Using alternative method."
          fi

      - name: Get PR changes
        id: pr-changes
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            
            const codeFiles = files
              .filter(f => f.status !== 'removed' && 
                      (f.filename.endsWith('.ts') || f.filename.endsWith('.tsx') || 
                       f.filename.endsWith('.js') || f.filename.endsWith('.jsx') ||
                       f.filename.endsWith('.tsx') || f.filename.endsWith('.css')))
              .map(f => ({
                filename: f.filename,
                status: f.status,
                additions: f.additions,
                deletions: f.deletions,
                patch: f.patch ? f.patch.substring(0, 5000) : ''
              }));
            
            return JSON.stringify({
              title: pr.title,
              body: pr.body || '',
              files: codeFiles,
              base: pr.base.sha,
              head: pr.head.sha
            });

      - name: Run Cursor AI Review
        id: cursor-review
        env:
          CURSOR_API_KEY: ${{ env.CURSOR_API_KEY }}
        run: |
          if [ -z "$CURSOR_API_KEY" ]; then
            echo "‚ö†Ô∏è CURSOR_API_KEY secret is not configured. Using fallback method."
            exit 0
          fi
          
          # Create review prompt file
          cat > /tmp/review-prompt.md << 'EOF'
          Please review this pull request and provide:
          1. **Critical Issues**: Security vulnerabilities, bugs, or breaking changes
          2. **Code Quality**: Best practices, patterns, and maintainability
          3. **Suggestions**: Specific improvements with code examples when helpful
          4. **Positive Feedback**: Acknowledge good practices and clean code
          
          Format your response in markdown with clear sections. Be constructive and specific.
          EOF
          
          # Use Cursor CLI to review the PR
          # Method 1: If Cursor CLI supports direct review
          if command -v cursor &> /dev/null; then
            PR_DATA='${{ steps.pr-changes.outputs.result }}'
            REVIEW=$(cursor review --api-key="$CURSOR_API_KEY" --prompt-file=/tmp/review-prompt.md --pr-data="$PR_DATA" 2>&1 || echo "‚ö†Ô∏è Cursor CLI review failed")
            echo "review<<EOF" >> $GITHUB_OUTPUT
            echo "$REVIEW" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            # Method 2: Use Cursor API directly
            PR_DATA='${{ steps.pr-changes.outputs.result }}'
            REVIEW=$(node .github/scripts/cursor-review.js "$PR_DATA" 2>&1 || echo "‚ö†Ô∏è Cursor API review failed")
            echo "review<<EOF" >> $GITHUB_OUTPUT
            echo "$REVIEW" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Post Cursor Review Comment
        uses: actions/github-script@v7
        if: steps.cursor-review.outputs.review
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const review = `${{ steps.cursor-review.outputs.review }}`;
            
            if (!review || review.includes('‚ö†Ô∏è')) {
              console.log('Skipping comment due to review error');
              return;
            }
            
            // Check if we already posted a review comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const existingComment = comments.find(c => 
              c.user.type === 'Bot' && 
              c.body.includes('ü§ñ Cursor AI Code Review')
            );
            
            const commentBody = `## ü§ñ Cursor AI Code Review\n\n${review}\n\n---\n*This review was automatically generated using Cursor AI via GitHub Actions.*`;
            
            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: commentBody
              });
            }

  summary:
    name: Analysis Summary
    runs-on: ubuntu-latest
    # needs: [codeql-analysis, sonarcloud-analysis, cursor-ai-review]
    needs: [codeql-analysis, cursor-ai-review]
    if: always()
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create Summary Comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const codeqlStatus = '${{ needs.codeql-analysis.result }}';
            # const sonarStatus = '${{ needs.sonarcloud-analysis.result }}';
            const cursorReviewStatus = '${{ needs.cursor-ai-review.result }}';
            
            const statusIcon = (status) => {
              if (status === 'success') return '‚úÖ';
              if (status === 'failure') return '‚ùå';
              if (status === 'cancelled') return '‚ö†Ô∏è';
              return '‚è∏Ô∏è';
            };
            
            const summary = `## üìä PR Analysis Summary
            
            | Analysis | Status |
            |----------|--------|
            | CodeQL Security | ${statusIcon(codeqlStatus)} ${codeqlStatus} |
            | SonarCloud Quality | ${statusIcon(sonarStatus)} ${sonarStatus} |
            | Cursor AI Review | ${statusIcon(cursorReviewStatus)} ${cursorReviewStatus} |
            
            ### üîç Details
            - **CodeQL**: Security vulnerability scanning completed
            - **SonarCloud**: Code quality and maintainability analysis completed
            - **Cursor AI**: Automated code review using Cursor AI completed
            
            ${codeqlStatus === 'failure' || sonarStatus === 'failure' ? '‚ö†Ô∏è **Action Required**: Please review the failed checks above.' : '‚úÖ All checks passed!'}
            
            ---
            *This summary is automatically generated by GitHub Actions.*
            `;
            
            // Check if summary comment already exists
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const existingSummary = comments.find(c => 
              c.user.type === 'Bot' && 
              c.body.includes('üìä PR Analysis Summary')
            );
            
            if (existingSummary) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingSummary.id,
                body: summary
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: summary
              });
            }

